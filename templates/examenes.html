<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Tareas y Refuerzos</title>
    <link rel="shortcut icon" type="image/png" href="static/icon.png"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <style>
        .btn-outline-primary{
            color: #02c594;
            border-color: #02c594;
        }
        .btn-outline-primary:hover {
            background-color: #02c594;
            border-color: #02c594;
        }

    </style>
</head>
<body>
    <div class="container text-center my-5">
        <div class="col-1">
            <button class="btn cbtn btn-outline-primary" id="regresar">Regresar</button>
        </div>
        <div>
            <img src="static/logo2.png" style="width:200px">
        </div>
        <div class="col-12 my-3">
            <h1>Cotiza tu examen</h1> 
            <p style="text-align: left;"><sup>*</sup>Datos obligatorios</p>           
        </div> 
    </div>
    <div class="container">
        <form method="POST" enctype="multipart/form-data" action="subexamenes">
            <div class="row">
                <div class="col-12 col-sm-6 my-3">
                    <label><strong>Tu nombre:<sup>*</sup></strong></label>
                    <input class="form-control" name="nombre" required/>   
                </div>
                <div class="col-12 col-sm-6 my-3">
                    <label><strong>Carrera:</strong></label>
                    <input class="form-control" />   
                </div>
                <div class="col-12 col-sm-6 my-3">
                    <label><strong>Materia:<sup>*</sup></strong></label>
                    <input class="form-control" name="materia" required/>
                </div>
                <div class="col-12 col-sm-6 my-3">
                    <label><strong>Tema:<sup>*</sup></strong></label>
                    <input class="form-control" name="tema" required/>
                </div>
                <div class="col-12 col-sm-6 my-3">
                    <label><strong>Correo electronico:</strong></label>
                    <input class="form-control" name="correo"/>
                </div>
                <div class="col-12 col-sm-6 my-3">
                    <label><strong>Numero de celular:<sup>*</sup></strong> (+57)</label>
                    <input class="form-control" name="celular" required/>
                </div>
                <div class="col-12 col-sm-6 my-3">
                    <label><strong>Tiempo del examen:<sup>*</sup></strong></label>
                    <input class="form-control" name="tiempo" required/>
                </div>
                <div class="col-12 col-sm-6 my-3">
                    <label><strong>Formato (Preguntas abiertas, seleccion multiple...):<sup>*</sup></strong></label>
                    <input class="form-control" name="formato" required/>
                </div>
                <div class="col-12 col-sm-6 my-3">
                    <label><strong>Fecha del examen:</strong><sup>*</sup>&nbsp;&nbsp;&nbsp;</label>
                    <input class="form-control" style="width:200px" type="date" name="fecha" required/>
                </div>
                <div class="col-12 col-sm-6 my-3">
                    <label><strong>Horas del examen:</strong> &nbsp;&nbsp;&nbsp;</label>
                    <input class="form-control" style="width:200px" type="time" name="hora"/>
                </div>
                <div class="col-12 my-3">
                    <label><strong>Por que medio deseas ser contactado:</strong></label>
                    <select class="form-control" name="medio">
                        <option value="celular">WhatApp</option>
                        <option value="correo">Correo electronico</option>
                    </select>
                </div>
                <div class="col-12 my-3">
                    <label><strong>Detalles a tener en cuenta:</strong></label>
                    <textarea class="form-control" name="detalles" rows="10" style="resize: none;"></textarea>   
                </div>
                <p>Aqu√≠ puedes adjuntar cualquier archivo relacionado al material de estudio (Maximo 20Mb) &#128071</p>
                <div style="text-align: center;">
                    <input class="btn btn-outline-primary" id="cargar" type="submit" value="Cargar archivos" />             
                </div>
                <div class="col-12 my-3">
                    <input id="file-input" type="file" name="file" multiple="multiple"/>                
                </div>
                <div style="text-align: center;">
                    <input class="btn btn-outline-primary" id="envia" type="submit" name="Enviar" value="Enviar" style="margin-bottom: 20px; text-align: center;"/>             
                </div>
                <table class="table table-bordered table-striped" id="table">
                    <colgroup>
                        <col>
                        <col style="width: 20px; text-align: center;">
                    </colgroup>
                    <thead class="thead-dark" style="color: white; background-color:#02c594;">
                        <th>Archivo</th>
                        <th>Eliminar</th>
                    </thead>
                    <tbody id = "tbody">
                </table>
                <div>
                    <input id="subfile" type="text" name="subfile"/>             
                </div>
            </div>
        </form>
    </div>
</body>
<script>
    var regresar = document.getElementById("regresar");
    var files = document.getElementById("file-input");
    var envia = document.getElementById("envia");
    var subfile = document.getElementById("subfile");
    var table = document.getElementById("tbody");
    var cargar = document.getElementById("cargar");
    files.style.visibility = "hidden";
    subfile.style.visibility = "hidden";
    document.getElementById("table").style.visibility = "hidden";
    var filenum = 0;
    var label = [];
    var ext = /(\.rar|\.pdf|\.doc|\.docx|\.xls|\.xlsx|\.jpeg|\.jpg|\.png|\.gif)$/i;
    files.addEventListener("change", function(){
        const xhr = new XMLHttpRequest();
        const form = new FormData();
        for (const file of files.files){
            if(file.size < 20*1024*1024){
                if(ext.exec(file.name)){
                    form.append("file",file);
                    filenum++;
                }else{
                    alert("La extension del archivo "+ file.name +" no es valida");
                }
            }else{
                alert("El archivo "+ file.name +" es demasiado pesado");
            };      
        }
        if(filenum > 0){
            document.getElementById("table").style.visibility = "visible";
            xhr.open("post","{{url_for('file')}}");
            xhr.addEventListener("loadstart", function(data){
                envia.disabled = true;
            })
            xhr.addEventListener("load", function(data){
                var resp = JSON.parse(data.target.response);
                
                for(const index of resp){
                    var row = table.insertRow(0);
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    cell1.innerHTML = index.name;
                    cell2.innerHTML = "<a onclick='borrar(this)'> &#128308 </a>";
                    label.push(index)
                }
                strconv();
                envia.disabled = false;
            })
            xhr.send(form);
        }
    });
    function borrar(e){
        const xhr = new XMLHttpRequest();
        const form = new FormData();
        var i = e.parentNode.parentNode.rowIndex;
        var val = -1;
        var element = document.getElementById("table").rows[i].cells[0].innerHTML;
        xhr.open("post","{{url_for('borrar')}}");
        xhr.addEventListener("loadstart", function(data){
            envia.disabled = true;
        })
        xhr.addEventListener("load", function(data){
            envia.disabled = false;
        })
        for(const index of label){
            if(index.name === element){
                form.append("file",index.file);
                xhr.send(form);
                label.splice(label.indexOf(index),1);
            }
        }
        strconv();
        document.getElementById("table").deleteRow(i);
        filenum--;
        if(filenum<1){
            document.getElementById("table").style.visibility = "hidden";
        }
    };
    function strconv(){
        var arr = [];
        for(const index of label){
            arr.push(index.file);
        }
        subfile.value = arr.toString();
    }
    cargar.addEventListener("click", function(evt) {
        evt.preventDefault();
        files.click();
    });
    regresar.addEventListener("click", function(){
        window.history.back();
    });
</script>
</html>