<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body{
            font-size: 20px;
            font-family: sans-serif;
        }
        table{

            border-collapse: collapse;
            width: 100%;
            border: 1px solid #e3e3e3;
            margin: 20px
        }
        th, td{
            padding: 10px;
            border: 1px solid #e3e3e3;
        }
        thead{
            background-color: #246355;
            color: white;
        }
    </style>
</head>
<body>
    <input id="file-input" name="file" type="file" multiple="multiple"> 
    <form method="POST" enctype="multipart/form-data" action="{{url_for('redirect')}}"> 
        <input id="subfile" type="text" name="subfile"/>
        <input id="dropfile" type="text" name="dropfile"/>
        <input id="but" type="submit"/>  
    </form>
    <table id="table" style="width: 80%;">
        <colgroup>
            <col>
            <col style="width: 20px; text-align: center;">
        </colgroup>
        <thead>
            <th>Archivo</th>
            <th>Eliminar</th>
        </thead>
        <tbody id = "tbody" style="font-size: 15px;">
    </table>
</body>
<script>
    var files = document.getElementById("file-input");
    var but = document.getElementById("but");
    var subfile = document.getElementById("subfile");
    var dropfile = document.getElementById("dropfile");
    var table = document.getElementById("tbody");
    //subfile.style.visibility = "hidden";
    document.getElementById("table").style.visibility = "hidden";
    var filenum = 0;
    var label = [];
    var ext = /(\.rar|\.pdf|\.doc|\.docx|\.xls|\.xlsx|\.jpeg|\.png|\.gif)$/i;
    files.addEventListener("change", function(){
        const xhr = new XMLHttpRequest();
        const form = new FormData();
        for (const file of files.files){
            if(file.size < 20*1024*1024){
                if(ext.exec(file.name)){
                    form.append("file",file);
                    filenum++;
                }else{
                    alert("La extension del archivo "+ file.name +" no es valida");
                }
            }else{
                alert("El archivo "+ file.name +" es demasiado pesado");
            };
            

        }
        if(filenum > 0){
            document.getElementById("table").style.visibility = "visible";
            xhr.open("post","{{url_for('file')}}");
            xhr.addEventListener("progress", function(data){
                but.disabled = true;
            })
            xhr.addEventListener("load", function(data){
                var resp = JSON.parse(data.target.response);
                
                for(const index of resp){
                    var row = table.insertRow(0);
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    cell1.innerHTML = index.name;
                    cell2.innerHTML = "<a onclick='borrar(this)'> &#128308 </a>";
                    label.push(index)
                }
                strconv();
                but.disabled = false;
            })
            xhr.send(form);
        }
    });
    function borrar(e){
        var i = e.parentNode.parentNode.rowIndex;
        var val = -1;
        var element = document.getElementById("table").rows[i].cells[0].innerHTML;
        for(const index of label){
            if(index.name === element){
                label.splice(label.indexOf(index),1);
            }
        }
        strconv();
        document.getElementById("table").deleteRow(i);
        filenum--;
        if(filenum<1){
            document.getElementById("table").style.visibility = "hidden";
        }
    };
    function strconv(){
        var arr = [];
        for(const index of label){
            arr.push(index.file);
        }
        subfile.value = arr.toString();
    }
</script>
</html>